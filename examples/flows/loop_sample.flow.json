{
  "version": "1.0",
  "meta": {
    "name": "Looping workflow",
    "description": "Validates data, retries up to 3 times, then finishes."
  },
  "environment": {
    "name": "dev",
    "region": "eu-central-1",
    "workflowType": "STANDARD",
    "roles": {
      "stateMachineRoleArn": "arn:aws:iam::111111111111:role/hla-flow-dev"
    },
    "storage": {
      "s3": {
        "workingBucket": "hla-flow-dev-working",
        "outputBucket": "hla-flow-dev-output",
        "kmsKeyArn": "arn:aws:kms:eu-central-1:111111111111:key/12345678-aaaa-bbbb-cccc-123456789012",
        "encryption": "KMS"
      }
    },
    "ecs": {
      "clusterArn": "arn:aws:ecs:eu-central-1:111111111111:cluster/hla-flow-dev",
      "subnets": ["subnet-0123456789abcdef0"],
      "securityGroups": ["sg-0123456789abcdef0"],
      "assignPublicIp": "DISABLED"
    }
  },
  "modules": [
    {
      "id": "ingest",
      "name": "Validate sample",
      "iamNeeds": ["ecs:runtask"],
      "runtime": {
        "taskDefinitionArn": "arn:aws:ecs:eu-central-1:111111111111:task-definition/ingest:1"
      }
    },
    {
      "id": "retry",
      "name": "Retry Task",
      "iamNeeds": ["ecs:runtask"],
      "runtime": {
        "taskDefinitionArn": "arn:aws:ecs:eu-central-1:111111111111:task-definition/retry:1"
      }
    }
  ],
  "graph": {
    "start": "ingest",
    "nodes": [
      {
        "id": "ingest",
        "name": "Validate sample",
        "kind": "module(ecs)",
        "moduleRef": "ingest"
      },
      {
        "id": "gate",
        "name": "Retry gate",
        "kind": "choice"
      },
      {
        "id": "retry-node",
        "name": "Retry",
        "kind": "module(ecs)",
        "moduleRef": "retry",
        "next": "gate"
      },
      {
        "id": "finish",
        "name": "Finish",
        "kind": "pass",
        "end": true
      },
      {
        "id": "invalid",
        "name": "Invalid input",
        "kind": "fail",
        "error": "InvalidInput",
        "cause": "Payload failed validation."
      }
    ],
    "edges": [
      {
        "source": "ingest",
        "target": "invalid",
        "condition": {
          "Variable": "$.inputValid",
          "BooleanEquals": false
        }
      },
      {
        "source": "ingest",
        "target": "gate",
        "default": true
      },
      {
        "source": "gate",
        "target": "retry-node",
        "condition": {
          "Variable": "$.attempts",
          "NumericLessThan": 3
        }
      },
      {
        "source": "gate",
        "target": "finish",
        "default": true
      }
    ]
  },
  "simulation": {
    "stateInput": {
      "attempts": 0,
      "inputValid": true
    }
  }
}
