# HLA-Compass Modules — Developer Handbook

End-to-end guide for building, testing, and publishing modules with the `hla-compass` SDK/CLI.

## 1) Audience & Scope
- Module authors: build backend-only modules (`no-ui`) or hybrid modules (`with-ui`).
- UI engineers: build UI bundles that the platform loads at runtime.
- CI maintainers: publish modules from GitHub Actions (container-first workflow).

Lifecycle:
`scaffold → develop → validate → test → build image → push to registry → publish → verify status`

## 2) Quick Start (5 minutes)

```bash
# 1) Install SDK
python -m pip install --upgrade pip
pip install hla-compass

# 2) Authenticate (choose environment)
hla-compass auth login --env dev

# 3) Scaffold a module
hla-compass init my-analyzer --template no-ui --interactive
cd my-analyzer

# 4) Validate + test
hla-compass validate --strict
hla-compass test --input examples/sample_input.json

# 5) Dev loop (Docker hot-reload parity)
hla-compass dev

# 6) (UI modules) Serve UI locally
hla-compass serve --port 8090
```

## 3) CLI Cheatsheet

- Auth
  - `hla-compass auth login --env dev|staging|prod`
  - `hla-compass auth status` / `hla-compass auth logout`
  - `hla-compass auth use-org <org-id>` (if you belong to multiple orgs)
- Project
  - `hla-compass init <name> --template ui|no-ui [--compute-type fargate]`
  - `hla-compass validate --strict`
  - `hla-compass preflight` (quick checks)
  - `hla-compass test [--docker] --input examples/sample_input.json`
  - `hla-compass dev [--payload examples/sample_input.json]`
  - `hla-compass serve --port 8090` (UI only)
- Build & publish
  - `hla-compass build --tag ghcr.io/<org>/<module>:<version> [--push]`
  - `hla-compass keys init` / `hla-compass keys show` (signing keys)
  - `hla-compass publish --env dev --scope org|public [--generate-keys] [--image-ref ...]`
  - `hla-compass publish-status --env dev --watch <publish-id>`
- Discover & run
  - `hla-compass list --env dev [--all]`
  - `hla-compass run --env dev <module-id> --parameters examples/sample_input.json`

## 4) Development Workflow

### Module layout (generated by `hla-compass init`)

**No-UI**
```text
my-module/
├── manifest.json
├── backend/
│   ├── main.py
│   └── requirements.txt
└── examples/
    └── sample_input.json
```

**With-UI**
```text
my-module/
├── manifest.json
├── backend/
├── frontend/
│   ├── index.tsx
│   ├── webpack.config.js
│   ├── package.json
│   └── dist/            # generated by `npm run build`
└── examples/
```

### Backend contract

Implement a `hla_compass.Module` subclass in `backend/main.py` and return results via `self.success(...)`.
Use `hla-compass test` and `hla-compass dev` to run locally.

### UI contract (with-UI only)

The UI build must produce a JavaScript bundle in `frontend/dist/` (default: `bundle.js`), and the bundle must expose `ModuleUI` as the UMD export (the UI template does this via `webpack.config.js`).

## 5) Testing & Validation

- `hla-compass validate --strict` checks manifest schema + structure and enforces SDK guardrails (including pinned Python dependencies in `backend/requirements.txt`).
- `hla-compass test --input ...` runs locally.
- `hla-compass test --docker --input ...` runs inside Docker for parity.
- `hla-compass dev` is the fastest loop for iterating with Docker parity and hot reload.

## 6) Build, Push, Publish

Modules are published from a container image reference (GHCR recommended).

```bash
# Build image
hla-compass build --tag ghcr.io/<org>/<module>:1.0.0

# Push to registry
docker push ghcr.io/<org>/<module>:1.0.0

# Publish to the platform catalog (org scope is default)
hla-compass publish --env dev --scope org --generate-keys --image-ref ghcr.io/<org>/<module>:1.0.0

# Watch intake status
hla-compass publish-status --env dev --watch <publish-id>
```

Notes:
- Versions are immutable; bump `manifest.json` `version` for every release.
- `--scope public` requires approval before other organizations can use the module.
- Signing keys are stored under `~/.hla-compass/keys/` (generate with `hla-compass keys init`, or let `publish --generate-keys` create them).

## 7) Registry Onboarding (Org Admins)

Your organization must approve container registry namespaces before publishing.
If you see `REGISTRY_UNAUTHORIZED`, ask your org admin to add your namespace (e.g., `ghcr.io/<org>/*`) in the platform settings.

## 8) CI/CD

Use the CI recipes in `docs/sdk-reference/guides/module-developer/ci_cd/ci_cd_for_modules.md`.

## 9) Troubleshooting

- `401` / expired auth → `hla-compass auth login --env <env>` then retry; check with `hla-compass auth status`.
- `REGISTRY_UNAUTHORIZED` → registry namespace not allow-listed for your org.
- `validate` failures → ensure `backend/requirements.txt` uses pinned versions (`==`).
- UI fails to load → run `npm install && npm run build` in `frontend/`, confirm the bundle exports `ModuleUI`.

## 10) Support

- Developer onboarding: integrations@alithea.bio
- Registry / infrastructure: platform-infra@alithea.bio
- Security: security@alithea.bio
